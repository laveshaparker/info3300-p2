<!DOCTYPE html>
<html>
    <head>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script src="globe_test.js"></script>
        <style>
            body {
                font-family: sans-serif;
                font-weight: 100;
            }
            h1, h2, h3, h4, h5, h6 {
                font-weight: 100;
            }
            #main {
                margin-right: auto;
                margin-left: auto;
                text-align: center;
            }
            .range {
                width: 500px;
            }
            .floated {
                float: left;
            }
            .three-fourths {
                width: 75%;
            }
            .one-fourth {
                width: 25%;
            }
			.stroke {
				fill: none;
				stroke: #000;
				stroke-width: 3px;
			}

			.fill {
				fill: #C6DEF6;
			}

			.graticule {
				fill: none;
				stroke: #777;
				stroke-width: .5px;
				stroke-opacity: .5;
			}

			.land {
				fill: green;
			}

			.boundary {
				fill: none;
				stroke: #fff;
				stroke-width: .5px;
			}
        </style>
        <script>
            window.twttr = (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0],
                    t = window.twttr || {};

                if (d.getElementById(id)) return t;
                js = d.createElement(s);
                js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);

                t._e = [];
                t.ready = function(f) {
                    t._e.push(f);
                };
             
                return t;
            }(document, "script", "twitter-wjs"));
        </script>
    </head>
    <body>
        <div class="floated one-fourth">
            <h2>Check out some of Samantha's most recent tweets!</h2>
            <blockquote class="twitter-tweet" lang="en"><p>Hello <a href="https://twitter.com/hashtag/India?src=hash">#India</a>! In the Tamil Nadu state, 3 temples from the Chola Empire (11th &amp; 12th century) are <a href="https://twitter.com/hashtag/WorldHeritage?src=hash">#WorldHeritage</a> site. <a href="http://t.co/kWRob1xxQK">pic.twitter.com/kWRob1xxQK</a></p>&mdash; Sam Cristoforetti (@AstroSamantha) <a href="https://twitter.com/AstroSamantha/status/588316473849946113">April 15, 2015</a></blockquote>
            <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
            <a class="twitter-timeline" href="https://twitter.com/AstroSamantha" data-widget-id="588409020664406017">Tweets by @AstroSamantha</a>
            <script>
                !function(d,s,id){
                    var js,fjs=d.getElementsByTagName(s)[0],
                        p=/^http:/.test(d.location)?'http':'https';
                    if(!d.getElementById(id)){
                        js=d.createElement(s);
                        js.id=id;
                        js.src=p+"://platform.twitter.com/widgets.js";
                        fjs.parentNode.insertBefore(js,fjs);
                    }
                }
                (document,"script","twitter-wjs");
            </script>
        </div>
        
        <div id="main" class="floated three-fourths">
			<!-- Shows the selected day as a string -->
            <p id="selectedDate"></p>
			<!-- Slider to pick a day from the data -->
            <input type="range" id="days" class="range" min="0" value="0" oninput="setDate(this.value)"/><br />
			<!-- Shows the selected time as a string -->
            <p id="selectedTime"></p>
			<!-- Slider to pick a time from the current day's data -->
            <input type="range" id="times" class="range" min="0" value="0" oninput="setTime(this.value)"/><br />
			<p>Set Play Speed</p>
			<!-- Slider to control the speed of the play function -->
			Slow&nbsp;<input type="range" id="speed" class="range" min="0" max="200" value="100"/>&nbsp;Fast<br />
			<!-- Button to cause the sliders to automatically advance at the chosen speed -->
			<button type="button" id="play" onclick="forward=setTimeout('moveForward()', speedScale($('#speed').val()));">Play</button>
			<!-- Button to stop sliders automatically advancing, hidden by default -->
			<button type="button" style="display: none" id="pause" onclick="pause(forward)">Pause</button>
            <script>
			//takes value of speed slider and scales it to a millisecond delay
			var speedScale = d3.scale.linear()
				.domain([0,200])
				.range([400, 4]);
			//variable for setTimeout of play feature
			var forward;
            //current orbit
            var current;
            //the unabridged date from fisOrbits
            var orbitData;
            //the orbits group by day
            var orbits = {};
            //orbits in array form
            var orbitArr = [];
            d3.json("friends-in-space-data/fisOrbits.json", function (data) {
                orbitData = data;
                //organizes data by day.  starts by taking each element of the array in fisOrbits
                orbitData.forEach(function(d){
					//variable to allow the coordinates for each day to be matched to the correct timestamp
                    var i = 0;
					//individually assesses and organizes each timestamp for the selected entry.  uses i to track corresponding coordinates
                    d.orbit.timestamps.forEach(function(e){
                        var date = new Date(e);
						//string to check for existing day entry
                        var dstring = date.getFullYear() + ', ' + date.getMonth() + ', ' + date.getDate();
						//checks if entry exists for current data's timestamp
                        if(orbits[dstring]){
							//pushes a new "orbit" to the current day
                            orbits[dstring].push({'date':date, 'coords':d.orbit.coordinates[i]});
                        }
                        else{
							//creates an entry for the current day
                            orbits[dstring] = [];
							//pushes a new "orbit" to the current day
                            orbits[dstring].push({'date':date, 'coords':d.orbit.coordinates[i]});
                        }
                        i++;
                    });
                });
                //outputs orbits as orbitArr
                $.each(orbits, function(d, e){
                        orbitArr.push(e);
                });
				//initialization call
                setDefault();
            });
            //initialize interface
            function setDefault(){
				//Max value of days initialized to number of days in the data -1
                $("#days").attr("max", orbitArr.length - 1);
				//Max value of times initialized to number of times in first day -1
                $("#times").attr("max", orbitArr[0].length - 1);
				//Sets text to first day and time respectively
                $("#selectedDate").text(orbitArr[0][0].date.toDateString());
                $("#selectedTime").text(orbitArr[0][0].date.toTimeString());
				//initializes current
                current = orbitArr[0][0];
				moveMap(0, 0);
            }
            //change in date
            function setDate(ind){
				//updates day text
                $("#selectedDate").text(orbitArr[ind][0].date.toDateString());
				//sets the max of #times to be the number of times for the selected day -1
                $("#times").attr("max", orbitArr[ind].length - 1);
				//updates current to the first time of the selected day
                current = orbitArr[ind][0];
				//updates time text
                $("#selectedTime").text(current.date.toTimeString());
				//Sets times slider to its min value
                $("#times").val(0);
				moveMap(ind, 0);
            }
            //change in time
            function setTime(ind){
				//updates current to the corresponding entry
                current = orbitArr[Number($('#days').val())][ind];
				//updates time text
                $("#selectedTime").text(current.date.toTimeString());
				moveMap($('#days').val(), ind);
            }
            </script>
			<script>
			//currently using kavrayskiy projection for 2D
			var width = 960,
    height = 500;

var projection = d3.geo.orthographic()
    .scale(250)
    .translate([width / 2, height / 2])
    .clipAngle(90);

var path = d3.geo.path()
    .projection(projection);

var pi = d3.scale.linear()
    .domain([0, width])
    .range([-180, 180]);

var gamma = d3.scale.linear()
    .domain([0, height])
    .range([90, -90]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

function moveMap(cDay, cTime) {
  var p = current.coords;
  projection.rotate([-p[0], -p[1]]);
  svg.selectAll("path").attr("d", path);
	if(cDay == 0 && cTime == 0) {
	svg.append("circle")
		.attr("r", 5)
		.attr("transform", "translate(" + projection(current.coords) + ")")
		.style("fill", "red");
  }		
}

d3.json("world-110m.json", function(error, world) {
  svg.append("path")
      .datum(topojson.feature(world, world.objects.land))
      .attr("class", "land")
      .attr("d", path);
});
svg.append('circle')
	.attr('cx', 480)
	.attr('cy', 250)
	.attr('r', 250)
	.style('fill', 'blue');

			d3.select(self.frameElement).style("height", height + "px");
			//implementation of play feature
			function moveForward(){
				//toggles buttons
				$('#play').hide();
				$('#pause').show();
				//case if not at end of day
				if($('#times').val() != $('#times').attr('max')){
					//increments times slider
					document.getElementById("times").stepUp();
					var ind = $('#times').val()
					current = orbitArr[Number($('#days').val())][ind];
					$("#selectedTime").text(current.date.toTimeString());
					//sets next instance of moveForward to happen after the time indicated by the speed slider
					moveMap(Number($('#days').val()), ind);
					forward=setTimeout('moveForward()', speedScale($('#speed').val()));
				}
				//case if end of day but not last day
				else if($('#days').val() != $('#days').attr('max')){
					document.getElementById("days").stepUp();
					//increments days slider
					var ind = $('#days').val();
					$("#selectedDate").text(orbitArr[ind][0].date.toDateString());
					$("#times").attr("max", orbitArr[ind].length - 1);
					current = orbitArr[ind][0];
					$("#selectedTime").text(current.date.toTimeString());
					$("#times").val(0);
					//sets next instance of moveForward to happen after the time indicated by the speed slider
					forward=setTimeout('moveForward()', speedScale($('#speed').val()));
				}
			}
			//pauses/stops the play function
			function pause(forward) {
				//toggles buttons
				$('#pause').hide();
				$('#play').show();
				//prevents moveForward from being called until the play button is pressed again
				clearTimeout(forward);
			}


			</script>
        </div>
    </body>
</html>
