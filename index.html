<!DOCTYPE html>
<html>
    <head>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
        <style>
            body {
                font-family: sans-serif;
                font-weight: 100;
            }
            h1, h2, h3, h4, h5, h6 {
                font-weight: 100;
            }
            #main {
                margin-right: auto;
                margin-left: auto;
                text-align: center;
            }
            .range {
                width: 500px;
            }
            .floated {
                float: left;
            }
            .three-fourths {
                width: 75%;
            }
            .one-fourth {
                width: 25%;
            }
			.stroke {
				fill: none;
				stroke: #000;
				stroke-width: 3px;
			}

			.fill {
				fill: #C6DEF6;
			}

			.graticule {
				fill: none;
				stroke: #777;
				stroke-width: .5px;
				stroke-opacity: .5;
			}

			.land {
				fill: #222;
			}

			.boundary {
				fill: none;
				stroke: #fff;
				stroke-width: .5px;
			}
        </style>
        <script>
            window.twttr = (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0],
                    t = window.twttr || {};

                if (d.getElementById(id)) return t;
                js = d.createElement(s);
                js.id = id;
                js.src = "https://platform.twitter.com/widgets.js";
                fjs.parentNode.insertBefore(js, fjs);

                t._e = [];
                t.ready = function(f) {
                    t._e.push(f);
                };
             
                return t;
            }(document, "script", "twitter-wjs"));
        </script>
    </head>
    <body>
        <div class="floated one-fourth">
            <h2>Check out some of Samantha's most recent tweets!</h2>
            <blockquote class="twitter-tweet" lang="en"><p>Hello <a href="https://twitter.com/hashtag/India?src=hash">#India</a>! In the Tamil Nadu state, 3 temples from the Chola Empire (11th &amp; 12th century) are <a href="https://twitter.com/hashtag/WorldHeritage?src=hash">#WorldHeritage</a> site. <a href="http://t.co/kWRob1xxQK">pic.twitter.com/kWRob1xxQK</a></p>&mdash; Sam Cristoforetti (@AstroSamantha) <a href="https://twitter.com/AstroSamantha/status/588316473849946113">April 15, 2015</a></blockquote>
            <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
            <a class="twitter-timeline" href="https://twitter.com/AstroSamantha" data-widget-id="588409020664406017">Tweets by @AstroSamantha</a>
            <script>
                !function(d,s,id){
                    var js,fjs=d.getElementsByTagName(s)[0],
                        p=/^http:/.test(d.location)?'http':'https';
                    if(!d.getElementById(id)){
                        js=d.createElement(s);
                        js.id=id;
                        js.src=p+"://platform.twitter.com/widgets.js";
                        fjs.parentNode.insertBefore(js,fjs);
                    }
                }
                (document,"script","twitter-wjs");
            </script>
        </div>
        
        <div id="main" class="floated three-fourths">
            <p id="selectedDate"></p>
            <input type="range" id="days" class="range" min="0" value="0" oninput="setDate(this.value)"/><br />
            <p id="selectedTime"></p>
            <input type="range" id="times" class="range" min="0" value="0" oninput="setTime(this.value)"/><br />
			<button type="button" id="play" onclick="forward=setInterval('moveForward()', 200);">Play</button>
			<button type="button" style="display: none" id="pause" onclick="pause(forward)">Pause</button>
            <script>
			var forward;
            //current orbit
            var current;
            //the unabridged date from fisOrbits
            var orbitData;
            //the orbits group by day
            var orbits = {};
            //orbits in array form
            var orbitArr = [];
            d3.json("friends-in-space-data/fisOrbits.json", function (data) {
                orbitData = data;
                //organizes data by day
                orbitData.forEach(function(d){
                    var i = 0;
                    d.orbit.timestamps.forEach(function(e){
                        var date = new Date(e);
                        var dstring = date.getFullYear() + ', ' + date.getMonth() + ', ' + date.getDate();
                        if(orbits[dstring]){
                            orbits[dstring].push({'date':date, 'coords':d.orbit.coordinates[i]});
                        }
                        else{
                            orbits[dstring] = [];
                            orbits[dstring].push({'date':date, 'coords':d.orbit.coordinates[i]});
                        }
                        i++;
                    });
                });
                //outputs orbits as orbitArr
                $.each(orbits, function(d, e){
                        orbitArr.push(e);
                });
                setDefault();
            });
            //initialize interface
            function setDefault(){
                $("#days").attr("max", orbitArr.length - 1);
                $("#times").attr("max", orbitArr[0].length - 1);
                $("#selectedDate").text(orbitArr[0][0].date.toDateString());
                $("#selectedTime").text(orbitArr[0][0].date.toTimeString());
                current = orbitArr[0][0];
            }
            //change in date
            function setDate(ind){
                $("#selectedDate").text(orbitArr[ind][0].date.toDateString());
                $("#times").attr("max", orbitArr[ind].length - 1);
                current = orbitArr[ind][0];
                $("#selectedTime").text(current.date.toTimeString());
                $("#times").val(0);
            }
            //change in time
            function setTime(ind){
                current = orbitArr[Number($('#days').val())][ind];
                $("#selectedTime").text(current.date.toTimeString());
            }
            </script>
			<script>
			var width = 1440,
				height = 855;
			//currently using kavrayskiy projection for 2D
			var projection = d3.geo.kavrayskiy7()
				.scale(170)
				.translate([width / 2, height / 2])
				.precision(.1);

			var path = d3.geo.path()
				.projection(projection);

			var graticule = d3.geo.graticule();

			var svg = d3.select("body").append("svg")
				.attr("width", width)
				.attr("height", height);

			svg.append("defs").append("path")
				.datum({type: "Sphere"})
				.attr("id", "sphere")
				.attr("d", path);

			svg.append("use")
				.attr("class", "stroke")
				.attr("xlink:href", "#sphere");

			svg.append("use")
				.attr("class", "fill")
				.attr("xlink:href", "#sphere");

			svg.append("path")
				.datum(graticule)
				.attr("class", "graticule")
				.attr("d", path);

			d3.json("world-50m.json", function(error, world) {
			  svg.insert("path", ".graticule")
				  .datum(topojson.feature(world, world.objects.land))
				  .attr("class", "land")
				  .attr("d", path);

			  svg.insert("path", ".graticule")
				  .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
				  .attr("class", "boundary")
				  .attr("d", path);
			});

			d3.select(self.frameElement).style("height", height + "px");
			
			function moveForward(){
				$('#play').hide();
				$('#pause').show();
				if($('#times').val() != $('#times').attr('max')){
					document.getElementById("times").stepUp();
					var ind = $('#times').val()
					current = orbitArr[Number($('#days').val())][ind];
					$("#selectedTime").text(current.date.toTimeString());
				}
				else if($('#days').val() != $('#days').attr('max')){
					document.getElementById("days").stepUp();
					var ind = $('#days').val();
					$("#selectedDate").text(orbitArr[ind][0].date.toDateString());
					$("#times").attr("max", orbitArr[ind].length - 1);
					current = orbitArr[ind][0];
					$("#selectedTime").text(current.date.toTimeString());
					$("#times").val(0);
				}
				else {
					clearInterval(forward);
				}
			}
			
			function pause(forward) {
				$('#pause').hide();
				$('#play').show();
				clearInterval(forward);
			}

			</script>
        </div>
    </body>
</html>
